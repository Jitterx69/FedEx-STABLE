
name: DAST (Dynamic Application Security Testing)

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to scan (e.g., https://staging.example.com)'
        required: true
      scan_type:
        description: 'Scan type'
        required: true
        type: choice
        options:
          - baseline
          - full

permissions:
  contents: read
  issues: write

jobs:
  # ---------------------------------------------------------------------------
  # OWASP ZAP Dynamic Scan
  # ---------------------------------------------------------------------------
  zap-scan:
    name: OWASP ZAP Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1

      - name: ZAP Baseline Scan
        if: ${{ github.event.inputs.scan_type == 'baseline' }}
        uses: zaproxy/action-baseline@de8ad967d3548d44ef623df22cf95c3b0baf8b25  # v0.14.0
        with:
          target: ${{ github.event.inputs.target_url }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          allow_issue_writing: true
          issue_title: 'ZAP Baseline Scan Report'

      - name: ZAP Full Scan
        if: ${{ github.event.inputs.scan_type == 'full' }}
        uses: zaproxy/action-full-scan@6eade8d9e0f4265403fbcb51b3524e9ee196bd7d  # v0.12.0
        with:
          target: ${{ github.event.inputs.target_url }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          allow_issue_writing: true
          issue_title: 'ZAP Full Scan Report'

  # ---------------------------------------------------------------------------
  # Nuclei Vulnerability Scan
  # ---------------------------------------------------------------------------
  nuclei-scan:
    name: Nuclei Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1

      - name: Install Nuclei
        run: |
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Run Nuclei Scan
        run: |
          nuclei -u ${{ github.event.inputs.target_url }} \
            -severity high,critical \
            -o nuclei-results.txt \
            -silent || true

      - name: Upload Nuclei Results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: nuclei-scan-results
          path: nuclei-results.txt
          retention-days: 30
